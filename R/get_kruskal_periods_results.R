# WARNING - Generated by {fusen} from dev/flat_data_contamination.Rmd: do not edit by hand # nolint: line_length_linter.

#' Get results of Kruskal-Wallis test between two periods of time
#' 
#' Get all information of Kruskal-Wallis test by PARAMETRE_LIBELLE and ESTUARY to be plotted
#' 
#' @param data_with_periode Dataset with columns ESTUARY, PARAMETRE_LIBELLE, RESULTAT, periode
#' @param chemicals vector of existing values in PARAMETRE_LIBELLE
#' @param estuaries vector of existing values in ESTUARY
#'
#' @return tibble containing, ESTUARY, PARAMETRE_LIBELLE, pvalue, median_1 (first period), median_2 (last period), max_value, trend (symbol to be plotted), y_pos (y position to be plotted)
#' 
#' @import dplyr
#' @import tidyr
#' 
#' @export
#' @examples
#' # get_kruskal_periods_results()
get_kruskal_periods_results <- function(data_with_periode, chemicals, 
                                         estuaries = c("Gironde", "Loire", "Seine")){
  
  # Create an empty tibble
  res_kruskal_periode <- tibble(ESTUARY = NA, PARAMETRE_LIBELLE = NA, pvalue = NA, 
                                 median_1 = NA, median_2 = NA, max_value = NA)
  
  for(chem in 1:length(chemicals)) {
    for (est in 1:length(estuaries)) {
      name_estuary <- estuaries[est]
      name_chemical <- chemicals[chem]
      # Filter data for a given estuary X chemical
      data_filtered <- data_with_periode |> 
        filter(PARAMETRE_LIBELLE == name_chemical, ESTUARY == name_estuary) |> 
        drop_na(periode)
      # Max value
      max_value = signif(max(data_filtered$RESULTAT), digits = 3)
      # Compute median values for the first and last period
      res_median <- data_filtered |> 
        group_by(periode) |> 
        summarise(median = median(RESULTAT) |> signif(4))
      # Test median difference
      kruskal_pvalue <- signif(kruskal.test(data_filtered$RESULTAT, data_filtered$periode)[["p.value"]], digits = 3)
      # Save results in the tibble
      res_kruskal_periode <- rbind(
        res_kruskal_periode,
        c(name_estuary, name_chemical, kruskal_pvalue, res_median$median, max_value)
      )
    }
  }
  # Get rid of the first line of the tibble created at its initialisation
  res_kruskal_periode <- res_kruskal_periode |> drop_na()
  
  # Mutate median columns to numerical and compute max median
  res_kruskal_periode <- res_kruskal_periode |> 
    mutate(median_1 = as.numeric(median_1),
           median_2 = as.numeric(median_2),
           max_value = as.numeric(max_value))
  
  # Get trend symbol
  res_kruskal_periode <- res_kruskal_periode |>
    mutate(
      trend = case_when(
        pvalue > 0.05 ~ "\u2192",
        median_1 > median_2 ~ "↓",
        median_2 > median_1 ~ "↑",
        TRUE ~ NA
      )
    )
  
  # Get max value by PARAMETRE_LIBELLE
  res_kruskal_periode <- res_kruskal_periode |>
    group_by(PARAMETRE_LIBELLE) |> 
    mutate(y_pos = max(max_value)) |> 
    ungroup()
  
  # Return tibble
  return(res_kruskal_periode)
}
