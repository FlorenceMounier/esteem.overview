# WARNING - Generated by {fusen} from dev/flat_fct_build_and_save_basemap.Rmd: do not edit by hand # nolint: line_length_linter.

#' Plot estuary map with points, optional variable mapping and optional horizontal/vertical lines
#'
#' @param data Data frame containing pos_lat_dd and pos_long_dd
#' @param estuary_name Character name of the estuary
#' @param colour_var Optional variable in `data` for point colour
#' @param fill_var Optional variable in `data` for point fill (shape 21)
#' @param size_var Optional variable in `data` for point size
#' @param package Package name where basemap is stored (default: "esteem.overview")
#'
#'
#' @import dplyr
#' @import ggplot2
#' @importFrom ggspatial annotation_scale
#' @importFrom ggspatial annotation_north_arrow
#' @importFrom ggspatial north_arrow_orienteering
#' @importFrom ggrepel geom_text_repel
#' @importFrom tidyterra geom_spatraster_rgb
#' @importFrom rlang ensym
#' @importFrom rlang sym
#' @importFrom sf st_as_sf
#' @importFrom sf st_coordinates
#' 
#' @return ggplot object
#' @export
#' @examples
#' # plot_estuary_map(
#' #   data = data_POMET |> filter(estuary == "Gironde"),
#' #   estuary_name = "Gironde",
#' #   colour_var = salinite,
#' # )
plot_estuary_map <- function(data,
                             estuary_name,
                             colour_var = NULL,
                             fill_var = NULL,
                             size_var = NULL,
                             package = "esteem.overview") {

  # -------------------------
  # 1. Charger fond de carte
  # -------------------------
  basemap <- load_estuary_basemap(estuary_name,
                                  package = package)

  # -------------------------
  # 2. Convertir data en sf
  # -------------------------
  points_sf <- make_points_sf(data)

  # -------------------------
  # 3. Construction de la carte
  # -------------------------
  p <- ggplot2::ggplot() +
    tidyterra::geom_spatraster_rgb(data = basemap$osm_raster)

  # -------------------------
  # 4. Ajouter points avec mapping dynamique
  # -------------------------

mapping <- list()

if (!missing(colour_var)) mapping$colour <- rlang::ensym(colour_var)
if (!missing(fill_var))   mapping$fill   <- rlang::ensym(fill_var)
if (!missing(size_var))   mapping$size   <- rlang::ensym(size_var)

if (length(mapping) > 0) {
  p <- p + geom_sf(
    data = points_sf,
    mapping = do.call(aes, lapply(mapping, rlang::sym)),
    shape = if (!missing(fill_var)) 21 else 19,
    alpha = 0.8
  )
} else {
  p <- p + geom_sf(
    data = points_sf,
    size = 2,
    alpha = 0.8
  )
}

  # -------------------------
  # 5. Ajouter villes si présentes
  # -------------------------
  if (!is.null(basemap$villes)) {
    # Points des villes
    p <- p + ggplot2::geom_sf(
      data = basemap$villes,
      shape = 21,
      fill = "black",
      color = "black",
      size = 3
    )
    
     # Convertir coordonnées pour labels
  villes_coords <- cbind(
    basemap$villes,
    sf::st_coordinates(basemap$villes)
  )
  
    # Labels des villes
  p <- p + ggrepel::geom_text_repel(
    data = villes_coords,
    aes(x = X, y = Y, label = name),
    min.segment.length = 0,
    nudge_y = 0.01,            # décale légèrement le texte
    size = 3,
    color = "black"
  )
  }

  # -------------------------
  # 6. Ajouter lignes horizontales/verticales si définies
  # -------------------------

# Ligne horizontale
if (!is.null(basemap$halin_limit_lat) && !is.na(basemap$halin_limit_lat)) {
  p <- p + ggplot2::geom_segment(
    data = data.frame(
      x = basemap$xlim[1],
      xend = basemap$xlim[2],
      y = basemap$halin_limit_lat,
      yend = basemap$halin_limit_lat
    ),
    mapping = aes(x = x, xend = xend, y = y, yend = yend),
    linetype = "solid",
    color = "red",
    linewidth = 1.2
  )
}

# Ligne verticale
if (!is.null(basemap$halin_limit_lon) && !is.na(basemap$halin_limit_lon)) {
  p <- p + ggplot2::geom_segment(
    data = data.frame(
      x = basemap$halin_limit_lon,
      xend = basemap$halin_limit_lon,
      y = basemap$ylim[1],
      yend = basemap$ylim[2]
    ),
    mapping = aes(x = x, xend = xend, y = y, yend = yend),
    linetype = "solid",
    color = "blue",
    linewidth = 1.2
  )
}

  # -------------------------
  # 7. Coordonnées + thème
  # -------------------------
  p <- p +
    ggplot2::coord_sf(
      xlim = basemap$xlim,
      ylim = basemap$ylim,
      expand = FALSE
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      axis.title = ggplot2::element_blank()
    )

  # -------------------------
  # 8. Echelle + flèche nord + titre
  # -------------------------
  p <- p +
  annotation_scale(
    location = "bl",      # bas gauche
    width_hint = 0.2,     # proportion de la carte
    text_cex = 1          # taille du texte
  ) +
  annotation_north_arrow(
      pad_x = unit(0.5, "cm"), # décale horizontalement
    pad_y = unit(0.7, "cm"), # décale verticalement
    which_north = "true",
    style = north_arrow_orienteering(),
    height = unit(0.5, "cm"),   # hauteur totale de la flèche
    width  = unit(0.5, "cm")  # largeur
  ) +
  labs(title = paste0(estuary_name, " estuary"))
    
    
  return(p)
}
