---
title: "data_contamination_others"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data_contamination_others}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
library(esteem.overview)
library(segmented)
library(tidyverse)
library(here)
```

# Get raw data
```{r}
data <- esteem.overview::data_ROCCHMV_cleaned |> ungroup() |> 
  filter(support == "Bivalve") |> 
  select(-c(SUPPORT_NIVEAU_PRELEVEMENT, support, niveau))
```

# Data for organochlorine compounds

## Get data for these chemicals

Lindane (gamma-HCH)
```{r}
data_lindane <- data |> filter(PARAMETRE_LIBELLE == "Gamma-HCH")
```

Total sum DDT isomers
```{r}
# Sum DDT
DDT <- c("p,p'-DDT", "o,p'-DDT", "p,p'-DDE", "p,p'-DDD")
data_DDT <- data |> 
  filter(PARAMETRE_LIBELLE %in% DDT) |> 
  group_by(ESTUARY, YEAR, espece, UNITE) |> 
  summarise(
    RESULTAT = sum(RESULTAT), 
    .groups = "drop") |> 
  mutate(PARAMETRE_LIBELLE = "sum_DDT")
```

Dioxins and dioxin-like compounds
```{r}
dioxine_like <- c(
  # DL-compounds: 12 DL-PCB
  "CB 77", "CB 81", "CB 105", "CB 114", "CB 118", "CB 123",
  "CB 126", "CB 156", "CB 157", "CB 167", "CB 169", "CB 189",
  # DL-compounds: 7 polychlorinated dibenzo-p-dioxins (PCDDs)
  "2,3,7,8-tetrachlorodibenzo-p-dioxine",
  "1,2,3,7,8-pentachlorodibenzo-p-dioxine",
  "1,2,3,4,7,8-hexachlorodibenzo-p-dioxine",
  "1,2,3,6,7,8-hexachlorodibenzo-p-dioxine",
  "1,2,3,7,8,9-hexachlorodibenzo-p-dioxine",
  "1,2,3,4,6,7,8- heptachlorodibenzo-p-dioxine",
  "octachlorodibenzo-p-dioxine", # OCDD 1,2,3,4,6,7,8,9-O8CDD
  # DL-compounds: 10 polychlorinated dibenzofurans (PCDFs)
  "2,3,7,8-tetrachlorodibenzofuran",
  "1,2,3,7,8-pentachlorodibenzofuran",
  "2,3,4,7,8-pentachlorodibenzofuran",
  "1,2,3,4,7,8-hexachlorodibenzofuran",
  "1,2,3,6,7,8-hexachlorodibenzofuran",
  "1,2,3,7,8,9-hexachlorodibenzofuran",
  "2,3,4,6,7,8-hexachlorodibenzofuran",
  "1,2,3,4,6,7,8-heptachlorodibenzofuran",
  "1,2,3,4,7,8,9-heptachlorodibenzofuran",
  "octachlorodibenzofuranne") # OCDF 1,2,3,4,6,7,8,9-O8CDF

data_dioxine_like <- data |> 
  filter(PARAMETRE_LIBELLE %in% dioxine_like) |> 
  group_by(ESTUARY, YEAR, espece, UNITE) |> 
  summarise(
    RESULTAT = sum(RESULTAT), 
    .groups = "drop") |> 
  mutate(PARAMETRE_LIBELLE = "sum_dioxine_like")
```

Polychlorinated biphenyls indicators (PCBi) => thresholds in ng/g lw
```{r}
PCBi <- c("CB 28", "CB 52", "CB 101", "CB 118", "CB 138", "CB 153", "CB 180")
data_PCBi <- data |> filter(PARAMETRE_LIBELLE %in% PCBi)
```

Joined data
```{r}
data_organochlorine <- data_DDT |> 
  full_join(data_lindane) |> 
  full_join(data_dioxine_like) |> 
  full_join(data_PCBi)
```
## Get the same unit of measurment

Conclusion :

- 1979-2015 : µg.kg-1 => dw
- 2017 : µg/(kg MS) => dw
- 2017-2024 : µg.kg-1, p.h. or ng.g-1, p.h. (equivalent) => ww
- ng.kg-1 : for sum_dioxine_like => dw

```{r}
data_organochlorine <- data_organochlorine |> 
  left_join(data_ROCCHMV_bio, by = "ESTUARY")
```

```{r}
data_organochlorine <- data_organochlorine |>
  mutate(RESULTAT = case_when(
    UNITE == "ng.kg-1" ~ RESULTAT / 1000
  ))
  mutate(UNITE = case_when(
    UNITE == "µg.kg-1, p.h." ~ "ng.g-1, p.h.",
    # => equivalent µg.kg-1, p.h.
    UNITE == "ng.kg-1" ~ "ng/g",
      TRUE ~ UNITE
  )) |>
  mutate(UNITE = as.factor(UNITE))

data_organochlorine |> 
  distinct(YEAR, UNITE, ESTUARY, PARAMETRE_LIBELLE) |>  View(title = "Organochlorine units")
```

```{r}
data_organochlorine_ww
```


dw or ww ?
```{r}
data_organochlorine |> 
  filter(PARAMETRE_LIBELLE %in% c("Gamma-HCH", "CB 153", "sum_DDT", "sum_dioxine_like")) |> 
  filter(ESTUARY == "Gironde", YEAR > 2010) |> 
ggplot() +
  aes(x = YEAR, y = RESULTAT, colour = UNITE) +
  geom_point() +
  facet_grid(vars(PARAMETRE_LIBELLE), scales = "free_y")
# => seems to be all in dw (p.h. is in the same range of values)
```


## Importance of the species matrix

Filtering bivalves and study the influence of species matrix:
- Gironde : only C. gigas
- Seine : only M. edulis
- Loire : 
  - 1979-2021: M. edulis
  - 2022-2023: M. edulis + M.galloprovincialis
  - 2018, 2021, 2024: Crassostrea gigas 
```{r}
data_organochlorine |> 
  distinct(ESTUARY, espece)

data_organochlorine |> 
  filter(ESTUARY == "Loire") |> 
  distinct(ESTUARY, YEAR, espece)
```

We see no step between species levels, bioaccumulation seems to be similar
```{r}
data_organochlorine |> 
  filter(ESTUARY == "Loire", YEAR > 2010) |>
  ggplot() +
  aes(x = YEAR, y = RESULTAT, colour = espece) +
  geom_line() +
  facet_wrap(vars(PARAMETRE_LIBELLE), scales = "free_y")
```

Simplify with two species groups
```{r}
data_organochlorine <- data_organochlorine |> 
    mutate(SPECIES = case_when(
    espece == "Crassostrea gigas (huître creuse)" ~ "oyster",
    espece %in% c("Mytilus edulis (moule commune)",
                  "Mytilus edulis + galloprovincialis (moule)") ~ "mussel"
  ))
```



## Identify first and last periods

Identify the first and last 5 years of measurement
```{r}
# Compute minimal and maximal year of measurement by compounds and estuary
min_max_year <- data_organochlorine |> 
  group_by(PARAMETRE_LIBELLE, ESTUARY) |> 
  summarise(min_year = min(YEAR),
            max_year = max(YEAR), .groups = "drop")

# Identify the first and last 5 years of measurement
data_organochlorine <- data_organochlorine |> 
  left_join(min_max_year, by = c("PARAMETRE_LIBELLE", "ESTUARY"))  |> 
  mutate(periode = case_when(
    YEAR <= min_year + 5 ~ "First 5 years",
    YEAR >= max_year - 5 ~ "Last 5 years",
    TRUE ~ NA
  ))
```

# Time series graphs
```{r}
data_organochlorine |> 
  filter(PARAMETRE_LIBELLE == "sum_DDT") |> 
ggplot() +
  aes(x = YEAR, y = RESULTAT, color = ESTUARY) +
  geom_line() +
  facet_grid(vars(PARAMETRE_LIBELLE), scales = "free_y") +
  labs(x = NULL)
```
# First vs last period graphs
```{r}
data_organochlorine |> 
  drop_na(periode) |> # keep only data from first and last 5-years periods
  filter(PARAMETRE_LIBELLE %in% PCBi) |> 
  ggplot() +
  aes(x = ESTUARY, y = RESULTAT, colour = periode) +
  geom_boxplot(width = 0.6, position = position_dodge(width = 0.9)) +
  scale_color_manual(values = c("purple", "deeppink")) +
  facet_grid(rows = vars(PARAMETRE_LIBELLE), scales = "free_y") +
  labs(x = NULL, y = "Concentration in µg/g dw", colour = "Period") +
  theme(legend.position = "bottom") 
# # Add long term trends if significant
#   geom_text(data = res_kruskal_metaux1, 
#             inherit.aes = FALSE, 
#             aes(x = ESTUARY, y = 0.9*y_pos, label = trend), size = rel(6),
#     family = "DejaVu Sans",   # specify the font that contains arrows
#     show.legend = FALSE)
```


# 
```{r}
# 
sum_PBDE <- c("PBDE 28", "PBDE 47", "PBDE 99", "PBDE 100", "PBDE 153", "PBDE 154")

data_ROCCHMV_summarised |>
  filter(PARAMETRE_LIBELLE %in% sum_DDT) |> View()
  distinct(YEAR, PARAMETRE_LIBELLE, UNITE) |> View()

data_ROCCHMV_sum_DDT <- data_ROCCHMV_summarised |> 
  filter(PARAMETRE_LIBELLE %in% sum_DDT) |> 
  group_by(ESTUARY, YEAR, SUPPORT_NIVEAU_PRELEVEMENT, UNITE) |> 
  summarise(RESULTAT = sum(RESULTAT)) |>  
  mutate(PARAMETRE_LIBELLE = "sum_DDT")

data_ROCCHMV_sum_DDT |> 
  ggplot() +
    aes(x = YEAR, y = sum_DDT, color = UNITE) +
  geom_line() +
  facet_grid(vars(ESTUARY))




data_ROCCHMV_summarised |>
  distinct(UNITE)

```
