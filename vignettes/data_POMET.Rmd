---
title: "data_POMET"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.show='hold')

library(esteem.overview)
library(tidyverse)



library(mixtools)
# remotes::install_github("r-spatial/mapview")
library(mapview)
library(sf)
library(maptiles)
library(tidyterra)
library(terra)
library(osmdata)
library(ggspatial)
library(ggrepel)  # pour éviter chevauchement labels
library(RColorBrewer)

col_gradient <- brewer.pal(n = 8, name = "RdYlGn")
```

# Salinity - Evolution temporelle en zone mesohaline

```{r}
data_mean_salinity <- data_POMET |>
  filter(haline_zone == "mesohalin") |>
  group_by(estuary, annee, saison) |>
  summarise(mean_salinity = mean(salinite, na.rm = TRUE))
ggplot(data = data_mean_salinity) +
  aes(x = annee, y = mean_salinity) +
  labs(title = "Salinity time evolution in mesohalin zone") +
  geom_col(position = "dodge") +
  facet_grid(rows = vars(saison), cols = vars(estuary))

ggplot(data = data_POMET |>
  filter(haline_zone == "mesohalin")) +
  aes(x = annee, y = salinite) +
  labs(title = "Salinity time evolution in mesohalin zone") +
  geom_point() +
  facet_grid(rows = vars(saison), cols = vars(estuary)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), se = TRUE)
```


# Fish size classes

## Subdataset of marine indicators in autumn

```{r}
data(data_POMET)
data_POMET_MJ_indicator <- data_POMET |>
  filter(name %in% c("Solea solea", "Dicentrarchus labrax"),
         saison == "automne")
```

## Biological size class - Sole

```{r}
longueurs_sole <- data_POMET_MJ_indicator |>
  filter(name == "Solea solea") |>
  drop_na(longueur) |>
  pull(longueur)
```

```{r}
# Ajustement du mélange
mix <- normalmixEM(longueurs_sole, k = 2)
summary(mix)

# Grille de valeurs
xgrid <- tibble(
  x = seq(min(longueurs_sole), max(longueurs_sole), length.out = 100000)
)

#  Densités pondérées
densites <- xgrid |>
  mutate(
    dens1 = mix$lambda[1] * dnorm(x, mix$mu[1], mix$sigma[1]),
    dens2 = mix$lambda[2] * dnorm(x, mix$mu[2], mix$sigma[2]),
    dens_tot = dens1 + dens2
  )

i1 <- which.max(densites$dens1)
i2 <- which.max(densites$dens2)

i_min <- min(i1, i2)
i_max <- max(i1, i2)

idx_creux <- i_min + which.min(densites$dens_tot[i_min:i_max]) - 1
seuil_sole <- densites$x[idx_creux]
```

```{r}
# Graph

dens_long <- densites |>
  select(x, dens1, dens2)  |>
  pivot_longer(-x, names_to = "groupe", values_to = "densite")

gg_sole_size_class <- ggplot() +
  # Histogramme
  geom_histogram(
    aes(x = longueurs_sole, y = after_stat(density)),
    bins = 40,
    fill = "grey80",
    color = "white"
  ) +

  # Gaussiennes
  geom_line(
    data = dens_long,
    aes(x = x, y = densite, color = groupe),
    linewidth = 1.2
  ) +

  # Seuil
  geom_vline(
    xintercept = seuil_sole,
    linetype = "dashed",
    linewidth = 1,
    color = "purple"
  ) +

  # Couleurs & labels
  scale_color_manual(
    values = c("dens1" = "red", "dens2" = "blue"),
    labels = c("G0", "G1"),
    name = "Distribution"
  ) +
  
  # Afficher la valeur du seuil
  annotate("label",
         x = Inf,
         y = Inf,
         label = paste0("Seuil = ", round(seuil_sole), "mm"),
         size = 4,
         hjust = 1.1,   # décale vers l'intérieur
         vjust = 1.1,
         fill = "white",
         color = "purple") +

  labs(
    x = "Longueur (mm)",
    y = "Densité",
    title = "Mélange gaussien et seuils de séparation - Sole"
  )

gg_sole_size_class

ggsave(filename = "../inst/results/data_POMET/fish_size_class/gg_sole_size_class.jpg", 
       plot = gg_sole_size_class, width = 15, height = 10, units = "cm")
```


## Biological size class - Seabass

```{r}
# get lengths
length_bar <- data_POMET_MJ_indicator |>
  filter(name == "Dicentrarchus labrax") |>
  pull(longueur)

hist(length_bar)
  

# Ajustement du mélange
mix <- normalmixEM(length_bar, k = 2)

# Grille de valeurs
xgrid <- tibble(
  x = seq(min(length_bar), max(length_bar), length.out = 100000)
)

#  Densités pondérées
densites <- xgrid |>
  mutate(
    dens1 = mix$lambda[1] * dnorm(x, mix$mu[1], mix$sigma[1]),
    dens2 = mix$lambda[2] * dnorm(x, mix$mu[2], mix$sigma[2]),
    dens_tot = dens1 + dens2
  )

i1 <- which.max(densites$dens1)
i2 <- which.max(densites$dens2)

i_min <- min(i1, i2)
i_max <- max(i1, i2)

idx_creux <- i_min + which.min(densites$dens_tot[i_min:i_max]) - 1
seuil_bar <- densites$x[idx_creux]
```

```{r}
dens_long <- densites |>
  select(x, dens1, dens2)  |>
  pivot_longer(-x, names_to = "groupe", values_to = "densite")

gg_seabass_size_class <- ggplot() +
  # Histogramme
  geom_histogram(
    aes(x = length_bar, y = after_stat(density)),
    bins = 40,
    fill = "grey80",
    color = "white"
  ) +

  # Gaussiennes
  geom_line(
    data = dens_long,
    aes(x = x, y = densite, color = groupe),
    linewidth = 1.2
  ) +

  # Seuil
  geom_vline(xintercept = seuil_bar, 
             linetype = "dashed", linewidth = 1, color = "purple") +

  # Couleurs & labels
  scale_color_manual(
    values = c("dens1" = "red", "dens2" = "blue"),
    labels = c("Groupe 1", "Groupe 2"),
    name = "Distribution"
  ) +
  
  # Afficher la valeur du seuil
  annotate("label",
         x = Inf,
         y = Inf,
         label = paste0("Seuil = ", round(seuil_bar), "mm"),
         size = 4,
         hjust = 1.1,   # décale vers l'intérieur
         vjust = 1.1,
         fill = "white",
         color = "purple") +

  labs(
    x = "Longueur (mm)",
    y = "Densité",
    title = "Mélange gaussien et seuils de séparation - Bar"
  )

gg_seabass_size_class

ggsave(filename = "../inst/results/data_POMET/fish_size_class/gg_seabass_size_class.jpg", 
       plot = gg_seabass_size_class, width = 15, height = 10, units = "cm")
```

## Biological size class repartition of individuals

```{r}
data_POMET_MJ_indicator <- data_POMET_MJ_indicator |>
  mutate(size_class = case_when(
    name == "Dicentrarchus labrax" & longueur <= seuil_bar ~ "G0",
    name == "Dicentrarchus labrax" & longueur > seuil_bar ~ "G1",
    name == "Solea solea" & longueur <= seuil_sole ~ "G0",
    name == "Solea solea" & longueur > seuil_sole ~ "G1",
    TRUE ~ NA
  ))

```

## Fish presence in estuaries

Calcul de l'Abondance poissons (= Nb d'indiv / surface ech. (long trait * long chalut) )
Petit chalut a perche (=CHAP3) * 1.5 ; Grand chalut a perche (CHAP3 DCE) * 3

```{r}
data_POMET_density <- data_POMET_MJ_indicator |>
  group_by(estuary, annee, materiel_code, trait_id, long_trait, name, haline_zone, size_class) |>
  # tot nb of individuals
  summarise(n_indiv = n(), .groups = "drop") |>
  # density per trait
  mutate(density_trait = case_when(
    materiel_code == "CHAP3" ~ (n_indiv / (long_trait * 1.5)) * 1000,
    materiel_code == "CHAP3 DCE" ~ (n_indiv / (long_trait * 3)) * 1000,
    TRUE ~ NA,
  )) |>
  # mean density per estuary, year, species and size class
  group_by(estuary, annee, name, haline_zone, size_class) |>
  summarise(density = mean(density_trait), .groups = "drop") |>
  mutate(log_density = log(density))
```

# Sole densities

```{r}
data_POMET_density_sole <- data_POMET_density |>
  filter(name == "Solea solea")

data_POMET_density_sole_gironde <- data_POMET_density_sole |> filter(estuary == "Gironde")

```


# Seabass densities

```{r}
data_POMET_density_seabass <- data_POMET_density |>
  filter(name == "Dicentrarchus labrax")

data_POMET_density_seabass_gironde <- data_POMET_density_seabass |> filter(estuary == "Gironde")
# mapview(data_POMET_density_seabass_gironde,
#         xcol = "pos_long_dd", ycol = "pos_lat_dd", zcol = "log_density",
#         col = "white", col.regions = col_gradient,
#         alpha.regions = 1, cex = 5, lwd = 0.5, crs = "+proj=longlat +datum=WGS84",
#         grid = FALSE)

data_POMET_density_seabass_loire <- data_POMET_density_seabass |> filter(estuary == "Loire")
# mapview(data_POMET_density_seabass_loire,
#         xcol = "pos_long_dd", ycol = "pos_lat_dd", zcol = "density",
#         col = "white", col.regions = col_gradient,
#         alpha.regions = 1, cex = 5, lwd = 0.5, crs = "+proj=longlat +datum=WGS84",
#         grid = FALSE)

data_POMET_density_seabass_seine <- data_POMET_density_seabass |> filter(estuary == "Seine")
# mapview(data_POMET_density_seabass_seine,
#         xcol = "pos_long_dd", ycol = "pos_lat_dd", zcol = "log_density",
#         col = "white", col.regions = col_gradient,
#         alpha.regions = 1, cex = 5, lwd = 0.5, crs = "+proj=longlat +datum=WGS84",
#         grid = FALSE)
```






# ---------------------------------------------------------------------------


# Prey species

```{r}
data_POMET |>
  distinct(phylum)

data_POMET |>
  filter(phylum != "Chordata") |>
  distinct(phylum, famille, name) |>
  arrange(phylum, famille) |>
  print(n = 48)
```




# ---------------------------------------------------------------------------
# ## Calcul de l'Abondance poissons (= Nb d'indiv / surface ech. (long trait * long chalut) )
#### Petit chalut a perche (=CHAP3) * 1.5 ; Grand chalut a perche (CHAP3 DCE) * 3


data_POMET_density <- data_POMET_MJ_indicator |>
  group_by(materiel_code, estuary, annee, trait_id, long_trait, name, size_class) |>
  # tot nb of individuals
  summarise(n_indiv = n(), .groups = "drop") |>
  # density per trait
  mutate(density_trait = case_when(
    materiel_code == "CHAP3" ~ (n_indiv / long_trait * 1.5) * 1000,
    materiel_code == "CHAP3 DCE" ~ (n_indiv / long_trait * 3) * 1000,
    TRUE ~ NA,
  )) |>
  # mean density per estuary, year, species and size class
  group_by(estuary, annee, name, size_class) |>
  summarise(density = mean(density_trait), .groups = "drop") |>
  drop_na(size_class)

ggplot(data_POMET_density) +
  aes(x = annee, y = density, colour = size_class) +
  geom_line() +
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.6,
    linewidth = 1
  ) +
  facet_grid(rows = vars(name), cols = vars(estuary), scales = "free_y")


# ---------------------------------------------------------------------------
# ## Calcul de la biomasse crevettes /unité surf (= Biomasse / surface ech. (long trait * long chalut) )
#### Petit chalut a perche

data_POMET_shrimps <- data_POMET |>
  filter(name %in% c("Crangon crangon", "Palaemon longirostris"),
         saison == "automne")

data_POMET_shrimps_biomass <- data_POMET_shrimps |>
  filter(!is.na(pt)) |>
  # biomass per trait
  mutate(biomass_trait = case_when(
    materiel_code == "CHAP3" ~ (pt / long_trait * 1.5) * 1000,
    materiel_code == "CHAP3 DCE" ~ (pt / long_trait * 3) * 1000,
    TRUE ~ NA,
  )) |>
  # mean biomass per estuary, year, species
  group_by(estuary, annee, name) |>
  summarise(biomass_trait = mean(biomass_trait), .groups = "drop")

ggplot(data_POMET_shrimps_biomass) +
  aes(x = annee, y = biomass_trait, colour = name) +
  geom_line() +
  geom_smooth(
    method = "loess",
    se = FALSE,
    span = 0.6,
    linewidth = 1
  ) +
  facet_grid(rows = vars(name), cols = vars(estuary), scales = "free_y")
