---
title: "data_benthos"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data_benthos}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
knitr::opts_chunk$set(echo = FALSE)
library(esteem.overview)
library(tidyverse, quietly = TRUE)
library(writexl)
# Maps
library(sf)
# Get taxonomy api
library(jsonlite) # install.packages("jsonlite", repos="http://cran.r-project.org")
library(httr) # install.packages("httr")

`%!in%` = Negate(`%in%`)
```

## REBENT Indicators

### Species richness

```{r}
# nb distinct species ever found per estuary
data_benthos_n_tot <- data_benthos_cleaned |> 
  group_by(ESTUARY, tidal) |> 
  distinct(species) |> 
  summarise(species_n_tot = n(), .groups = "drop")

# nb of distinct species found for each year and each estuary
REBENT_richness <- data_benthos_cleaned |> 
  group_by(ESTUARY, YEAR, tidal, phylum) |> 
  distinct(species) |> 
  summarise(species_per_year = n(), .groups = "drop") |> 
  left_join(data_benthos_n_tot) |> 
  mutate(percent_species_occ = species_per_year / species_n_tot * 100)
```

```{r}
ggplot_REBENT_richness <- REBENT_richness |> group_by(ESTUARY, tidal, YEAR) |> 
  summarise(species_per_year = sum(species_per_year)) |> 
  ggplot() +
  aes(x = YEAR, y = species_per_year, color = ESTUARY, 
      linetype = tidal, shape = tidal) +
  geom_line(position = "dodge") +
  geom_point() +
  labs(title = "REBENT macrobenthic fauna: Species richness", 
       x = NULL, 
       y = "Species Richness (#/year)",
       color = "Estuary")

ggsave(plot = ggplot_REBENT_richness,
       "../inst/results/data_benthos/indicators/ggplot_REBENT_species_richness.jpg",
       width = 17, height = 10, units = "cm")

ggplot_REBENT_richness
```


```{r}
ggplot_REBENT_richness_taxonomy <- REBENT_richness |> 
  filter(phylum %in% c("Annelida", "Arthropoda", "Mollusca")) |> 
  ggplot() +
  aes(x = YEAR, y = species_per_year, color = ESTUARY, 
      linetype = tidal, shape = tidal) +
  geom_line(position = "dodge") +
  facet_grid(vars(phylum)) +
  geom_point() +
  labs(title = "REBENT macrobenthic fauna: Species richness", 
       x = NULL, 
       y = "Species Richness (#/year)",
       color = "Estuary")

ggsave(plot = ggplot_REBENT_richness_taxonomy,
       "../inst/results/data_benthos/indicators/ggplot_REBENT_species_richness_taxonomy.jpg",
       width = 17, height = 10, units = "cm")

ggplot_REBENT_richness_taxonomy
```

### Abundance/Density

#### Number of individual per m2 at a given LIEU_MNEMONIQUE & DATE

One line per species: nb of individuals
```{r}
data_benthos_ind_species_m2 <- data_benthos_cleaned |> 
  # nb of sub-sample per LIEU_MNEMONIQUE & DATE & sampler_type
  group_by(ESTUARY, LIEU_MNEMONIQUE, DATE, sampler_type, tidal) |> 
  mutate(nb_samples_lieu_mnemonique_date = unique(mnemonique) |>  length()) |> 
  # summarise nb of ind per species at a given LIEU_MNEMONIQUE & DATE & sampler_type
  group_by(ESTUARY, LIEU_MNEMONIQUE, DATE, sampler_type, sampler_surface,
           tidal, nb_samples_lieu_mnemonique_date, species) |> 
  summarise(nb_ind_species_lieu_mnemonique_date = sum(RESULTAT)) |> 
  # compute nb of in per species for the total surface of LIEU_MNEMONIQUE 
  mutate(nb_ind_species_per_m2 = nb_ind_species_lieu_mnemonique_date / (sampler_surface * nb_samples_lieu_mnemonique_date)) |> 
  ungroup()

data_benthos_ind_species_m2
```

Yearly mean of individuals per surface
```{r}
data_benthos_ind_m2 <- data_benthos_ind_species_m2 |> 
  mutate(YEAR = year(DATE)) |> 
  group_by(ESTUARY, YEAR, DATE, LIEU_MNEMONIQUE, tidal) |> 
  summarise(nb_ind_per_m2 = sum(nb_ind_species_per_m2)) |> 
  group_by(ESTUARY, YEAR, tidal) |> 
  summarise(mean_abundance_m2 = mean(nb_ind_per_m2)) |> 
  ungroup()
```


```{r}
ggplot_REBENT_density <- ggplot(data_benthos_ind_m2) +
  aes(x = YEAR, y = mean_abundance_m2, color = ESTUARY,
      linetype = tidal, shape = tidal) +
  geom_line(position = "dodge") +
  geom_point() +
  labs(title = "REBENT macrobenthic fauna: Density", 
       x = NULL, 
       y = "Density (mean nb ind/m²)",
       color = "Estuary")

ggsave(plot = ggplot_REBENT_density,
       "../inst/results/data_benthos/indicators/ggplot_REBENT_density.jpg",
       width = 17, height = 10, units = "cm")

ggplot_REBENT_density
```

#### Species richness per square metre

```{r}
# Number of species per sample
data_n_species_by_sample <- data_benthos_ind_species_m2 |> 
  group_by(ESTUARY, LIEU_MNEMONIQUE, DATE, tidal) |> 
  summarise(n_species = n(), .groups = "drop")

# Sample surface
data_sample_surface <- data_benthos_ind_species_m2 |> 
  distinct(ESTUARY, LIEU_MNEMONIQUE, DATE, sampler_type, sampler_surface, tidal, nb_samples_lieu_mnemonique_date) |> 
  mutate(surface_sample = sampler_surface * nb_samples_lieu_mnemonique_date)

# Compute species richness by m²
data_species_richness <- left_join(data_n_species_by_sample, data_sample_surface) |> 
  mutate(n_species_per_m2 = n_species / surface_sample)

# Summarise per estuary and year
data_species_richness_year <- data_species_richness |> 
  mutate(YEAR = year(DATE)) |> 
  group_by(ESTUARY, YEAR, tidal) |> 
  summarise(mean_year_n_species_per_m2 = mean(n_species_per_m2), 
            sum_sample_surface = sum(surface_sample), .groups = "drop")
```

Impact of total surface sampled variability on estimated species richness:
```{r}
## Total surface sampled variability
  ggplot_surface_variability <- ggplot(data = data_species_richness_year) +
    aes(x = YEAR, y = sum_sample_surface, color = ESTUARY,
        linetype = tidal, shape = tidal) +
    geom_point() + geom_line() +
    labs(x = NULL, y = "Total surface sampled (m²)", 
         title = "Rebent macrobenthic fauna: Total surface sampled variability")
  ggplot_surface_variability
  ggsave(plot = ggplot_surface_variability, filename = "../inst/results/data_benthos/indicators/ggplot_REBENT_surface_variability.jpg",
         width = 15, height = 6, units = "cm")

  # ## Correlation between species richness and total surface sampled
  # model_lm <- lm(data = data_species_richness_year, 
  #    formula = mean_year_n_species_per_m2 ~ sum_sample_surface)
  # summary(model_lm) 
  
  ggplot_surface_richness_correlation <- ggplot(data = data_species_richness_year) +
    aes(x = sum_sample_surface, y = mean_year_n_species_per_m2, 
        color = ESTUARY, linetype = tidal, shape = tidal) +
    geom_point() +
    labs(x = "Total surface sampled", y = "Species richness",
         title = "Correlation between yearly total surface sampled and species richness")
  ggplot_surface_richness_correlation
  ggsave(plot = ggplot_surface_richness_correlation, filename = "../inst/results/data_benthos/indicators/ggplot_REBENT_surface_richness_correlation.jpg",
           width = 15, height = 6, units = "cm")
```

Plot of species richness per m² per estuary and year:
```{r}
ggplot_species_richness_year <- ggplot(data_species_richness_year) +
  aes(x = YEAR, y = mean_year_n_species_per_m2, color = ESTUARY,
      linetype = tidal, shape = tidal) +
  geom_point() +
  geom_line() +
  labs(title = "REBENT macrobenthic fauna - Species richness per square metre", 
       x = NULL, y = "Mean number of species per m²",
       color = "Estuary")
ggplot_species_richness_year
ggsave(plot = ggplot_species_richness_year, filename = "../inst/results/data_benthos/indicators/ggplot_REBENT_species_richness_year.jpg",
       width = 15, height = 6, units = "cm")
```

### Occurrence and relative frequencies

```{r}
# n_sample_tot
n_sample_tot <- data_benthos_cleaned |> 
  distinct(ESTUARY, tidal, LIEU_MNEMONIQUE, YEAR) |> 
  count() |>  pull()

data_benthos_cleaned |> 
  distinct(ESTUARY, tidal, LIEU_MNEMONIQUE, YEAR, species) |> 
  arrange(species) |> 
  group_by(species) |> 
  summarise(species_n_tot = n(), .groups = "drop") |> 
  mutate(species_occ = species_n_tot / n_sample_tot * 100)

```

