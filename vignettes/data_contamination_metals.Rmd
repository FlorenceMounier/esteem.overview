---
title: "data_contamination_metals"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data_contamination}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(esteem.overview)
library(segmented)
library(tidyverse)
library(here)
```

# Get raw data
```{r}
data <- esteem.overview::data_ROCCHMV_cleaned |> ungroup()
```

# Data for metals
```{r}
# Historical once
df_metal1 <- data.frame(PARAMETRE_LIBELLE_FR = c("Mercure", "Cadmium", "Plomb", "Zinc", "Cuivre"),
                        PARAMETRE_LIBELLE_EN = c("Mercury", "Cadmium", "Lead", "Zinc", "Copper"),
                        intercept1 = c(90/1000, 960/1000, 1300/1000, NA, NA),
                        intercept2 = c(3049/1000, 305/1000, 9146/1000, NA, NA),
                        unit = c("µg/g dw", "µg/g dw", "µg/g dw", NA, NA))

# More recently monitored
df_metal2 <- data.frame(PARAMETRE_LIBELLE_FR = c("Nickel", "Vanadium", "Argent", "Chrome total"),
                        PARAMETRE_LIBELLE_EN = c("Nickel", "Vanadium", "Silver", "Chromium"))

# All of them
metaux <- full_join(df_metal1, df_metal2)
```

## Importance of the species matrix

Only for Bivalves (no interesting results for fish)

Filtering bivalves and study the influence of species matrix
```{r}
data_metaux <- data |> 
  filter(PARAMETRE_LIBELLE %in% metaux$PARAMETRE_LIBELLE_FR) |> 
  filter(support == "Bivalve") |> 
  left_join(metaux, by = c("PARAMETRE_LIBELLE" = "PARAMETRE_LIBELLE_FR")) |> 
  mutate(PARAMETRE_LIBELLE = factor(PARAMETRE_LIBELLE_EN, levels = metaux$PARAMETRE_LIBELLE_EN)) |>
  dplyr::select(-PARAMETRE_LIBELLE_EN)
```

- Gironde : only C. gigas
- Seine : only M. edulis
- Loire : 
  - 1979-2021: M. edulis
  - 2022-2024: M. edulis + M.galloprovincialis
  - 2011-2013 : R. philippinarum duplicate
  - 2017-2024 : C. gigas
```{r}
data_metaux |> 
  distinct(ESTUARY, espece)

data_metaux |> 
  filter(ESTUARY == "Loire") |> 
  count(YEAR, espece)
```

For several metals oyster and mussels bioaccumulation is very different
```{r}
data_metaux |> 
  filter(ESTUARY == "Loire") |>
  ggplot() +
  aes(x = YEAR, y = RESULTAT, colour = espece) +
  geom_line() +
  facet_wrap(vars(PARAMETRE_LIBELLE), scales = "free_y")
```

Estimate species conversion factor from data in the Loire estuary (2017-2024)
```{r}
data_metaux <- data_metaux |> 
  filter(espece != "Ruditapes philippinarum (palourde japonaise)") |>
  mutate(SPECIES = case_when(
    espece == "Crassostrea gigas (huître creuse)" ~ "oyster",
    espece %in% c("Mytilus edulis (moule commune)",
                  "Mytilus edulis + galloprovincialis (moule)") ~ "mussel"
  ))

data_metaux_loire <- data_metaux |> 
  filter(ESTUARY == "Loire", YEAR >= 2017)
  
factors_metals <- data_metaux_loire |> 
  group_by(PARAMETRE_LIBELLE, SPECIES) |> 
  summarise(median_RESULTAT = median(RESULTAT, na.rm = TRUE), .groups = "drop")  |> 
  pivot_wider(names_from = SPECIES, values_from = median_RESULTAT)  |> 
  mutate(
    factor_oyster_to_mussel = mussel / oyster,
    factor_mussel_to_oyster = oyster / mussel
  )

writexl::write_xlsx(x = factors_metals, path = "../inst/results/data_contam/metals/conversion_factors_metal.xlsx")
```

Compute results in "equivalent mussels"
```{r}
data_metaux <- data_metaux |> 
  left_join(factors_metals, by = "PARAMETRE_LIBELLE") |> 
  mutate(RESULTAT_raw = RESULTAT) |> 
  mutate(RESULTAT = case_when(
    SPECIES == "oyster" ~ RESULTAT * factor_oyster_to_mussel,
    SPECIES == "mussel" ~ RESULTAT
  ))
```

## Biometric information

Check biometric information
```{r}
data_metaux_bio <- data |> 
  filter(PARAMETRE_LIBELLE %in% c("Matière sèche", "Taille de l'individu", "Lipides totaux")) |>
  filter(espece %in% c("Mytilus edulis (moule commune)",
                  "Mytilus edulis + galloprovincialis (moule)")) |> 
  group_by(ESTUARY, YEAR, PARAMETRE_LIBELLE, UNITE) |> 
  summarise(RESULTAT = mean(RESULTAT))

data_metaux_bio |> 
  filter(PARAMETRE_LIBELLE == "Matière sèche") |> 
  ggplot(aes(x = YEAR, y = RESULTAT, colour = ESTUARY)) +
  geom_line()+
  geom_smooth(method = "lm", formula = y ~ 1, se = FALSE) +
  geom_hline(yintercept = 16.4, size = 1.2) +
  labs(title = "Dry content comparison with OSPAR value",
       x = NULL, y = "Dry content (%)")
```

## Get unit of measurment

Conclusion : original unit in mg/kg dw (equivalent in µg/g dw)

- 1979-2019 : "mg.kg-1"
- 2020-2024 : "mg/(kg MS)" and "mg.kg-1" or only "mg/(kg MS)"
```{r}
# data_metaux |>
#   distinct(YEAR, UNITE, ESTUARY, PARAMETRE_LIBELLE, espece) |>  View()

data_metaux |> 
  filter(ESTUARY == "Gironde", PARAMETRE_LIBELLE == "Mercury") |> 
ggplot() +
  aes(x = YEAR, y = RESULTAT, colour = UNITE) +
  geom_point()
# => seems to be in the same range of values
```

```{r}
data_metaux <- data_metaux |> 
  mutate(UNITE = "µg/g dw")
```

## Identify first and last periods

Identify the first and last 5 years of measurement
```{r}
# Compute minimal and maximal year of measurement by metal and estuary
min_max_year <- data_metaux |> 
  group_by(PARAMETRE_LIBELLE, ESTUARY) |> 
  summarise(min_year = min(YEAR),
            max_year = max(YEAR), .groups = "drop")

# Identify the first and last 5 years of measurement
data_metaux <- data_metaux |> 
  left_join(min_max_year, by = c("PARAMETRE_LIBELLE", "ESTUARY"))  |> 
  mutate(periode = case_when(
    YEAR <= min_year + 5 ~ "First 5 years",
    YEAR >= max_year - 5 ~ "Last 5 years",
    TRUE ~ NA
  ))
```


# Historical heavy metals

```{r}
data_metaux1 <- data_metaux |> filter(PARAMETRE_LIBELLE %in% df_metal1$PARAMETRE_LIBELLE_EN)

ggplot(data_metaux1) +
  aes(x = YEAR, y = log(RESULTAT), color = ESTUARY) +
  geom_line() +
  facet_grid(vars(fct_relevel(PARAMETRE_LIBELLE, df_metal1$PARAMETRE_LIBELLE_EN)), scales = "free_y") +
  labs(x = NULL)
```

```{r}
# res_metals1_trends <- rbind(
#   fun_seg_model(data = data_metaux1, chemical = "Mercury", estuary = "Gironde", n_break = 2),
#   fun_seg_model(data = data_metaux1, chemical = "Mercury", estuary = "Loire", n_break = 2),
#   fun_seg_model(data = data_metaux1, chemical = "Mercury", estuary = "Seine", n_break = 2),
#   fun_seg_model(data = data_metaux1, chemical = "Cadmium", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux1, chemical = "Cadmium", estuary = "Loire"),
#   fun_seg_model(data = data_metaux1, chemical = "Cadmium", estuary = "Seine", n_break = 2),
#   fun_seg_model(data = data_metaux1, chemical = "Lead", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux1, chemical = "Lead", estuary = "Loire"),
#   fun_seg_model(data = data_metaux1, chemical = "Lead", estuary = "Seine"),
#   fun_seg_model(data = data_metaux1, chemical = "Zinc", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux1, chemical = "Zinc", estuary = "Loire"),
#   fun_seg_model(data = data_metaux1, chemical = "Zinc", estuary = "Seine"),
#   fun_seg_model(data = data_metaux1, chemical = "Copper", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux1, chemical = "Copper", estuary = "Loire"),
#   fun_seg_model(data = data_metaux1, chemical = "Copper", estuary = "Seine")
#   )

# usethis::use_data(res_metals1_trends, overwrite = TRUE)

esteem.overview::res_metals1_trends
```

```{r}
ggplot_metaux1 <- ggplot(data_metaux1) +
  aes(x = YEAR,
      y = log(RESULTAT),
      colour = ESTUARY) +
  geom_line() +
  geom_smooth(se = FALSE) +
  theme(legend.position = "bottom") +
  facet_grid(rows = vars(
    fct_relevel(PARAMETRE_LIBELLE, df_metal1$PARAMETRE_LIBELLE_EN)
  ), scales = "free_y") +
  labs(colour = "Estuary", y = "Contamination level in log µg/g dw", x = NULL) +
# Add last break dates of segmented models and arrows for significant last trends
  geom_vline(data = res_metals1_trends, aes(xintercept = break_dates, colour = ESTUARY)) +
  geom_text(
    data = res_metals1_trends,
    aes(x = last_year+1, y = log(last_resultat), label = symbol), size = rel(6),
    family = "DejaVu Sans",   # specify the font that contains arrows
    show.legend = FALSE) +
# Add environmental threshold when existing
  # => BAC mussel
  geom_hline(
    data = df_metal1 |> rename(PARAMETRE_LIBELLE = PARAMETRE_LIBELLE_EN),
    aes(yintercept = log(intercept1)),
    color = "black", linetype = "dashed"
  ) +
  # => EC MPC
  geom_hline(
    data = df_metal1 |> rename(PARAMETRE_LIBELLE = PARAMETRE_LIBELLE_EN),
    aes(yintercept = log(intercept2)),
    color = "red", linetype = "dashed"
   )

ggplot_metaux1

ggsave(plot = ggplot_metaux1, "../inst/results/data_contam/metals/ggplot_metals1_time_series.jpg",
       width = 10, height = 15, units = "cm")
```

```{r}
res_kruskal_metaux1 <- get_kruskal_periods_results(data_with_periode = data_metaux1, 
                             chemicals = df_metal1$PARAMETRE_LIBELLE_EN)
```

```{r}
plot_metals1_periode <- data_metaux1 |> 
  drop_na(periode) |> # keep only data from first and last 5-years periods
  ggplot() +
  aes(x = ESTUARY, y = RESULTAT, colour = periode) +
  geom_boxplot(width = 0.6, position = position_dodge(width = 0.9)) +
  scale_color_manual(values = c("purple", "deeppink")) +
  facet_grid(rows = vars(fct_relevel(PARAMETRE_LIBELLE, df_metal1$PARAMETRE_LIBELLE_EN)), scales = "free_y") +
  labs(x = NULL, y = "Concentration in µg/g dw", colour = "Period") +
  theme(legend.position = "bottom") +
# Add long term trends if significant
  geom_text(data = res_kruskal_metaux1, 
            inherit.aes = FALSE, 
            aes(x = ESTUARY, y = 0.9*y_pos, label = trend), size = rel(6),
    family = "DejaVu Sans",   # specify the font that contains arrows
    show.legend = FALSE)

plot_metals1_periode

ggsave(plot = plot_metals1_periode, "../inst/results/data_contam/metals/ggplot_metals1_periods.jpg", 
       width = 10, height = 15, units = "cm")
```

# Other metals original

```{r}
data_metaux2 <- data_metaux |> filter(PARAMETRE_LIBELLE %in% df_metal2$PARAMETRE_LIBELLE_EN)
ggplot(data_metaux2) +
  aes(x = YEAR, y = log(RESULTAT), color = ESTUARY) +
  geom_line() +
  facet_grid(vars(fct_relevel(PARAMETRE_LIBELLE, df_metal2$PARAMETRE_LIBELLE_EN)), scales = "free_y") +
  labs(x = NULL)
```

```{r}
# res_metals2_trends <- rbind(
#   fun_seg_model(data = data_metaux2, chemical = "Nickel", estuary = "Gironde", n_break = 2),
#   fun_seg_model(data = data_metaux2, chemical = "Nickel", estuary = "Loire", n_break = 3),
#   fun_seg_model(data = data_metaux2, chemical = "Nickel", estuary = "Seine", n_break = 2),
#   fun_seg_model(data = data_metaux2, chemical = "Vanadium", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux2, chemical = "Vanadium", estuary = "Loire"),
#   fun_seg_model(data = data_metaux2, chemical = "Vanadium", estuary = "Seine"),
#   fun_seg_model(data = data_metaux2, chemical = "Silver", estuary = "Gironde"),
#   fun_seg_model(data = data_metaux2, chemical = "Silver", estuary = "Loire"),
#   fun_seg_model(data = data_metaux2, chemical = "Silver", estuary = "Seine"),
#   fun_seg_model(data = data_metaux2, chemical = "Chromium", estuary = "Gironde", n_break = 2),
#   fun_seg_model(data = data_metaux2, chemical = "Chromium", estuary = "Loire"),
#   fun_seg_model(data = data_metaux2, chemical = "Chromium", estuary = "Seine", n_break = 2)
#   )
# 
# usethis::use_data(res_metals2_trends, overwrite = TRUE)

esteem.overview::res_metals2_trends
```

```{r}
ggplot_metaux2 <- ggplot(data_metaux2) +
  aes(x = YEAR,
      y = log(RESULTAT),
      colour = ESTUARY) +
  geom_line() +
  geom_smooth(se = FALSE) +
  theme(legend.position = "bottom") +
  facet_grid(rows = vars(
    fct_relevel(PARAMETRE_LIBELLE, df_metal2$PARAMETRE_LIBELLE_EN)
  ), scales = "free_y") +
  labs(colour = "Estuary", y = "Contamination level in log µg/g dw", x = NULL) +
# Add last break dates of segmented models and arrows for significant last trends
  geom_vline(data = res_metals2_trends, aes(xintercept = break_dates, colour = ESTUARY)) +
  geom_text(
    data = res_metals2_trends,
    aes(x = last_year+1, y = log(last_resultat), label = symbol), size = rel(6),
    family = "DejaVu Sans",   # specify the font that contains arrows
    show.legend = FALSE)

ggplot_metaux2

ggsave(plot = ggplot_metaux2, "../inst/results/data_contam/metals/ggplot_metals2_time_series.jpg",
       width = 10, height = 15, units = "cm")
```

```{r}
res_kruskal_metaux2 <- get_kruskal_periods_results(data_with_periode = data_metaux2, 
                             chemicals = df_metal2$PARAMETRE_LIBELLE_EN)
```

```{r}
plot_metals2_periode <- data_metaux2 |> 
  drop_na(periode) |> # keep only data from first and last 5-years periods
  ggplot() +
  aes(x = ESTUARY, y = RESULTAT, colour = periode) +
  geom_boxplot(width = 0.6, position = position_dodge(width = 0.9)) +
  scale_color_manual(values = c("purple", "deeppink")) +
  facet_grid(rows = vars(fct_relevel(PARAMETRE_LIBELLE, df_metal2$PARAMETRE_LIBELLE_EN)), scales = "free_y") +
  labs(x = NULL, y = "Concentration in µg/g dw", colour = "Period") +
  theme(legend.position = "bottom") +
# Add long term trends if significant
  geom_text(data = res_kruskal_metaux2, 
            inherit.aes = FALSE, 
            aes(x = ESTUARY, y = 0.9*y_pos, label = trend), size = rel(6),
    family = "DejaVu Sans",   # specify the font that contains arrows
    show.legend = FALSE)

plot_metals2_periode

ggsave(plot = plot_metals2_periode, "../inst/results/data_contam/metals/ggplot_metals2_periods.jpg", 
       width = 10, height = 15, units = "cm")
```


